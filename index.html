<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Events Organisation</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <!-- Modal styles (minimal, injected) -->
    <style>
    .hidden{display:none}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal-card{background:#fff;border-radius:10px;max-width:420px;width:92%;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,0.2);font-family:inherit}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-header h3{margin:0;font-size:1.1rem}
    .icon-btn{background:transparent;border:none;font-size:1.1rem;cursor:pointer}
    .modal-body label{display:block;font-size:0.85rem;margin:10px 0 6px}
    .modal-body input{width:100%;padding:8px 10px;border:1px solid #ccc;border-radius:6px}
    .modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:#2727ff;color:#fff}
    .btn-secondary{background:#f1f1f1}
    @media (max-width:480px){.modal-card{padding:14px}}
    /* Login popover styles */
    .login-popover{position:fixed;z-index:10010;display:flex;align-items:flex-start;justify-content:flex-start}
    .login-popover.hidden{display:none}
    .popover-card{background:#fff;color:#111;border-radius:8px;box-shadow:0 8px 30px rgba(0,0,0,0.25);width:300px;max-width:84vw;padding:10px}
    .popover-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .popover-body label{display:block;font-size:0.85rem;margin:6px 0}
    .popover-body input{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px}
    @media (max-width:480px){.popover-card{width:92vw}}
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK (will be used for Auth + Firestore). Replace the firebaseConfig object below with your project's values. -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
    <header class="topbar">
        <!-- Login Hamburger Dropdown (left) -->
        <div class="login-menu-wrapper">
            <button class="hamburger login-hamburger" id="loginMenuToggle" aria-haspopup="true" aria-expanded="false" aria-label="Open profile menu">üë§</button>
            <div class="menu login-menu" id="loginMenu">
                <button class="menu-item" id="loginBtn">Login</button>
                <button class="menu-item" id="signupBtn">Signup</button>
                <button class="menu-item" id="logoutBtn">Logout</button>
            </div>
        </div>
        <div class="brand">
            <span class="logo">üéµ</span>
            <span class="title">Music Event's</span>
        </div>
        <!-- Event Hamburger Dropdown (right) -->
        <div class="menu-wrapper">
            <button class="hamburger" id="menuToggle" aria-haspopup="true" aria-expanded="false" aria-label="Open menu">‚ò∞</button>
            <div class="menu" id="menu">
                <button class="menu-item" id="A">A</button>
                <button class="menu-item" id="B">B</button>
                <button class="menu-item" id="C">C</button>
                <button class="menu-item" id="D">D</button>
                <button class="menu-item" id="E">E</button>
                <button class="menu-item" id="F">F</button>
                <button class="menu-item" id="G">G</button>
                <button class="menu-item" id="H">H</button>
                <button class="menu-item" id="I">I</button>
                <button class="menu-item" id="J">J</button>
                <button class="menu-item" id="K">K</button>
                <button class="menu-item" id="L">L</button>
                <button class="menu-item" id="M">M</button>
                <button class="menu-item" id="N">N</button>
                <button class="menu-item" id="O">O</button>
                <button class="menu-item" id="P">P</button>
                <button class="menu-item" id="Q">Q</button>
                <button class="menu-item" id="R">R</button>
                <button class="menu-item" id="S">S</button>
                <button class="menu-item" id="T">T</button>
                <button class="menu-item" id="U">U</button>
                <button class="menu-item" id="V">V</button>
                <button class="menu-item" id="W">W</button>
                <button class="menu-item" id="X">X</button>
                <button class="menu-item" id="Y">Y</button>
                <button class="menu-item" id="Z">Z</button>
            </div>
        </div>
    </header>

    <div class="layout">
        <div class="sidebar-bar-toggle" id="sidebarBarToggle" aria-label="Show instruments">
            <div class="bar-btn" id="barBtn"></div>
        </div>
        <aside class="sidebar" aria-label="Instrument selector">
            <div class="sidebar-header">
                <h2>Instruments</h2>
            </div>
            <ul class="instrument-list" id="instrumentList" tabindex="0" aria-multiselectable="true">
                <!-- Items injected by JS -->
            </ul>
        </aside>

        <main class="content">
        </main>
    </div>

    <!-- Modal backdrop (single instance) -->
    <div id="modalBackdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-card" role="document">
            <div class="modal-header">
                <h3 id="modalTitle">Modal</h3>
                <button class="icon-btn" id="closeModal" aria-label="Close">‚úñ</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be injected by script (login / signup forms) -->
            </div>
        </div>
    </div>

    <!-- Login popover (anchored small popup) -->
    <div id="loginPopover" class="login-popover hidden" role="dialog" aria-modal="false" aria-labelledby="loginPopoverTitle">
        <div class="popover-card">
            <div class="popover-header">
                <strong id="loginPopoverTitle">Login</strong>
                <button class="icon-btn" id="closePopover" aria-label="Close">‚úñ</button>
            </div>
            <div class="popover-body" id="loginPopoverBody">
                <!-- content injected by script -->
            </div>
        </div>
    </div>

    <!-- Floating action button (bottom-right) -->
    <div class="fab" id="fab">
        <button class="fab-btn" id="fabToggle" aria-haspopup="true" aria-expanded="false" aria-label="Open quick menu">‚óè</button>
        <div class="fab-menu" id="fabMenu">
            <button class="fab-item" id="suggestionBtn">Suggestion</button>
            <button class="fab-item" id="helpBtn">Help</button>
        </div>
    </div>

    <script src="app.js"></script>
        <script>
        (function(){
                const modalBackdrop = document.getElementById('modalBackdrop');
                const modalTitle = document.getElementById('modalTitle');
                const modalBody = document.getElementById('modalBody');
                const loginPopover = document.getElementById('loginPopover');
                const loginPopoverBody = document.getElementById('loginPopoverBody');
                const loginMenuToggle = document.getElementById('loginMenuToggle');

                if(modalBackdrop){
                        modalBackdrop.classList.add('hidden');
                        modalBackdrop.style.display = 'none';
                }
                if(loginPopover){
                        loginPopover.classList.add('hidden');
                        loginPopover.style.display = 'none';
                        loginPopover.style.left = '0px';
                        loginPopover.style.top = '0px';
                }

                function showModal(mode){
                                if(!modalBackdrop || !modalBody) return;
                                // Add login-page class to body for blank background
                                document.body.classList.add('login-page');
                                modalBackdrop.style.display = '';
                                modalBackdrop.classList.remove('hidden');
                                document.body.style.overflow = 'hidden';
                                if(mode === 'signup'){
                                        modalTitle.textContent = 'Create Account';
                                        modalBody.innerHTML = `
                                                <form id="signupForm">
                                                    <div>
                                                        <label for="signupFullName">Full Name</label>
                                                        <input id="signupFullName" name="signupFullName" type="text" placeholder="Enter your full name" required>
                                                    </div>
                                                    <div>
                                                        <label for="signupEmail">Email</label>
                                                        <input id="signupEmail" name="signupEmail" type="email" placeholder="Enter your email" required>
                                                    </div>
                                                    <div>
                                                        <label for="signupMobile">Mobile Number</label>
                                                        <input id="signupMobile" name="signupMobile" type="tel" placeholder="Enter mobile number" required>
                                                    </div>
                                                    <div>
                                                        <label for="signupPassword">Create Password</label>
                                                        <input id="signupPassword" name="signupPassword" type="password" placeholder="Create password" required>
                                                    </div>
                                                    <div>
                                                        <label for="signupConfirm">Confirm Password</label>
                                                        <input id="signupConfirm" name="signupConfirm" type="password" placeholder="Confirm password" required>
                                                    </div>
                                                    <div class="modal-actions">
                                                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                                                        <button type="submit" class="btn btn-primary" id="signupSubmit">Create Account</button>
                                                    </div>
                                                    <div style="text-align: center; margin-top: 15px;">
                                                        <span style="color: #666; font-size: 0.9rem;">Already have an account? </span>
                                                        <button type="button" class="btn btn-link" id="loginAccountBtn" style="background: none; border: none; color: #2727ff; text-decoration: underline; cursor: pointer; font-size: 0.9rem;">Login</button>
                                                    </div>
                                                </form>
                                        `;
                                } else if(mode === 'login'){
                                        modalTitle.textContent = 'Login';
                                        modalBody.innerHTML = `
                                                <form id="loginForm">
                                                    <div>
                                                        <label for="loginFullName">Full Name</label>
                                                        <input id="loginFullName" name="loginFullName" type="text" placeholder="Enter your full name" required>
                                                    </div>
                                                    <div>
                                                        <label for="loginEmail">Email or Mobile Number</label>
                                                        <input id="loginEmail" name="loginEmail" type="text" placeholder="Enter email or mobile number" required>
                                                    </div>
                                                    <div>
                                                        <label for="loginPassword">Password</label>
                                                        <input id="loginPassword" name="loginPassword" type="password" placeholder="Enter password" required>
                                                    </div>
                                                    <div class="modal-actions">
                                                        <button type="button" class="btn btn-secondary" id="forgotPwdBtn">Forgot Password</button>
                                                        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                                                        <button type="submit" class="btn btn-primary" id="loginSubmit">Login</button>
                                                    </div>
                                                    <div style="text-align: center; margin-top: 15px;">
                                                        <span style="color: #666; font-size: 0.9rem;">Don't have an account? </span>
                                                        <button type="button" class="btn btn-link" id="createAccountBtn" style="background: none; border: none; color: #2727ff; text-decoration: underline; cursor: pointer; font-size: 0.9rem;">Create Account</button>
                                                    </div>
                                                </form>
                                        `;
                                }
                                const firstInput = modalBody.querySelector('input');
                                if(firstInput) firstInput.focus();
                        }

                function showUserAccountModal(){
                    if(!modalBackdrop || !modalBody) return;
                    modalBackdrop.style.display = '';
                    modalBackdrop.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                    modalTitle.textContent = 'My Account';
                    
                    const user = auth.currentUser;
                    if(!user) {
                        alert('No user logged in');
                        hideModal();
                        return;
                    }
                    
                    // Get user profile from Firestore
                    db.collection('users').doc(user.uid).get()
                    .then(doc => {
                        const userData = doc.exists ? doc.data() : { email: user.email, mobile: '' };
                        const userEmail = userData.email || user.email || '';
                        const userMobile = userData.mobile || '';
                        
                        modalBody.innerHTML = `
                            <form id="userAccountForm">
                                <div>
                                    <label for="accountFullName">Full Name</label>
                                    <input id="accountFullName" name="accountFullName" type="text" value="${userData.fullName || ''}" required>
                                </div>
                                <div>
                                    <label for="accountEmail">Email</label>
                                    <input id="accountEmail" name="accountEmail" type="email" value="${userEmail}" required>
                                </div>
                                <div>
                                    <label for="accountMobile">Mobile Number</label>
                                    <input id="accountMobile" name="accountMobile" type="tel" value="${userMobile}" required>
                                </div>
                                <div>
                                    <label for="accountPassword">New Password (leave blank to keep current)</label>
                                    <input id="accountPassword" name="accountPassword" type="password" placeholder="Enter new password">
                                </div>
                                <div>
                                    <label for="accountConfirmPassword">Confirm New Password</label>
                                    <input id="accountConfirmPassword" name="accountConfirmPassword" type="password" placeholder="Confirm new password">
                                </div>
                                <div class="modal-actions">
                                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                                    <button type="submit" class="btn btn-primary" id="updateAccountBtn">Update Account</button>
                                </div>
                            </form>
                        `;
                        const firstInput = modalBody.querySelector('input');
                        if(firstInput) firstInput.focus();
                    })
                    .catch(err => {
                        console.error('Error fetching user data:', err);
                        alert('Error loading account data');
                        hideModal();
                    });
                }

                function showPopover(){
                    console.log('showPopover called');
                    if(!loginPopover || !loginPopoverBody || !loginMenuToggle) { console.log('popover elements missing'); return; }
                        // inject form
                        loginPopoverBody.innerHTML = `
                            <form id="loginPopoverForm">
                                <div>
                                    <label for="loginFullName">Full Name</label>
                                    <input id="loginFullName" name="loginFullName" type="text" placeholder="Enter your full name" required>
                                </div>
                                <div>
                                    <label for="loginEmail">Email or Mobile Number</label>
                                    <input id="loginEmail" name="loginEmail" type="text" placeholder="Enter email or mobile number" required>
                                </div>
                                <div>
                                    <label for="loginPassword">Password</label>
                                    <input id="loginPassword" name="loginPassword" type="password" placeholder="Enter password" required>
                                </div>
                                <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
                                    <button type="button" class="btn btn-secondary" id="forgotPwdBtn">Forgot</button>
                                    <button type="button" class="btn btn-secondary" id="closePopoverBtn">Cancel</button>
                                    <button type="submit" class="btn btn-primary" id="loginPopoverSubmit">Login</button>
                                </div>
                            </form>
                        `;
                        // position popover near the profile button after paint (ensure width is measured correctly)
                        loginPopover.style.display = 'flex';
                        loginPopover.classList.remove('hidden');
                        requestAnimationFrame(function(){
                            const rect = loginMenuToggle.getBoundingClientRect();
                            const pop = loginPopover.querySelector('.popover-card');
                            // default position below and aligned to left edge of button
                            let left = rect.left;
                            let top = rect.bottom + 8;
                            const popWidth = pop ? pop.offsetWidth : 300;
                            if(left + popWidth > window.innerWidth - 8) left = window.innerWidth - popWidth - 8;
                            if(left < 8) left = 8;
                            loginPopover.style.left = left + 'px';
                            loginPopover.style.top = top + 'px';
                            const firstInput = loginPopover.querySelector('input');
                            if(firstInput) firstInput.focus();
                            console.log('popover positioned', { left, top, popWidth });
                        });
                }

                function hideModal(){
                        if(!modalBackdrop) return;
                        // Remove login-page class from body
                        document.body.classList.remove('login-page');
                        modalBackdrop.classList.add('hidden');
                        modalBackdrop.style.display = 'none';
                        document.body.style.overflow = '';
                        modalBody.innerHTML = '';
                }

                // Function to update login dropdown based on auth state
                function updateLoginDropdown(isLoggedIn, user = null){
                    const loginMenu = document.getElementById('loginMenu');
                    const loginMenuToggle = document.getElementById('loginMenuToggle');
                    if(!loginMenu || !loginMenuToggle) return;
                    
                    if(isLoggedIn && user){
                        // Show first letter of full name in profile button
                        const userInitial = user.fullName ? user.fullName.charAt(0).toUpperCase() : (user.email ? user.email.charAt(0).toUpperCase() : 'U');
                        loginMenuToggle.textContent = userInitial;
                        loginMenuToggle.title = `Logged in as ${user.fullName || user.email}`;
                        
                        // Update dropdown menu
                        loginMenu.innerHTML = `
                            <button class="menu-item" id="myAccountBtn">My Account</button>
                            <button class="menu-item" id="logoutBtn">Logout</button>
                        `;
                    } else {
                        // Show default profile icon
                        loginMenuToggle.textContent = 'üë§';
                        loginMenuToggle.title = 'Login';
                        
                        // Update dropdown menu
                        loginMenu.innerHTML = `
                            <button class="menu-item" id="loginBtn">Login</button>
                            <button class="menu-item" id="signupBtn">Signup</button>
                        `;
                    }
                }

                function hidePopover(){
                        if(!loginPopover) return;
                        loginPopover.classList.add('hidden');
                        loginPopover.style.display = 'none';
                        loginPopoverBody.innerHTML = '';
                }

        // --- Firebase Auth + Firestore helpers (client-side) ---
        // IMPORTANT: Replace firebaseConfig with the real values from the Firebase console for the project
        // that you create under the mail address you will provide. Do NOT commit service account keys.
        const firebaseConfig = {
            apiKey: "AIzaSyBk9voLnYCmAtimrIZDK9F_dFO3sQCyMII",
            authDomain: "sri-music-events-37987.firebaseapp.com",
            projectId: "sri-music-events-37987",
            storageBucket: "sri-music-events-37987.firebasestorage.app",
            messagingSenderId: "171969258087",
            appId: "1:171969258087:web:cb29c4efff579eae17aac2",
            measurementId: "G-R0TES365LE"
        };

        // Initialize Firebase if config provided
        let auth = null, db = null;
        try{
            if(firebaseConfig && Object.keys(firebaseConfig).length){
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                console.log('Firebase initialized (client)');
            } else {
                console.log('Firebase config not provided - running in local/demo mode');
            }
        }catch(e){ console.warn('Firebase init error', e); }

        // Save a user profile to Firestore under users/{uid}
        function saveProfile(uid, profile){
            if(!db) return Promise.reject(new Error('Firestore not initialized'));
            return db.collection('users').doc(uid).set(profile, { merge: true });
        }

        // Functions to hide/show main content until authenticated
        function hideContent(){
            const layout = document.querySelector('.layout');
            const bottom = document.querySelector('.bottom-boxes');
            const bg = document.querySelector('.music-bg');
            if(layout) layout.style.display = 'none';
            if(bottom) bottom.style.display = 'none';
            if(bg) bg.style.display = 'none';
        }
        function showContent(){
            const layout = document.querySelector('.layout');
            const bottom = document.querySelector('.bottom-boxes');
            const bg = document.querySelector('.music-bg');
            if(layout) layout.style.display = '';
            if(bottom) bottom.style.display = '';
            if(bg) bg.style.display = '';
        }

        // Keep track of auth state (Firebase only - no localStorage fallback)
        if(typeof firebase !== 'undefined' && firebase && firebase.auth){
            try{
                if(auth){
                    auth.onAuthStateChanged(function(user){
                        if(user){
                            console.log('firebase signed-in as', user.email || user.uid);
                            hidePopover(); hideModal();
                            showContent();
                            // Get user profile from Firestore
                            db.collection('users').doc(user.uid).get()
                            .then(doc => {
                                const userData = doc.exists ? doc.data() : { email: user.email };
                                updateLoginDropdown(true, userData);
                            })
                            .catch(() => {
                                updateLoginDropdown(true, { email: user.email });
                            });
                        } else {
                            console.log('no firebase user signed in');
                            hideContent();
                            updateLoginDropdown(false);
                            // show login modal so user must sign in
                            showModal('login');
                        }
                    });
                }
            }catch(e){ console.warn('auth state handling error', e); }
        } else {
            // Firebase not configured - show error and require setup
            console.error('Firebase not configured. Please check your Firebase configuration.');
            hideContent();
            updateLoginDropdown(false);
            showModal('login');
        }

                        // Delegated click handlers: Signup opens modal; other generic handlers
                        document.addEventListener('click', function(e){
                                const target = e.target;
                                if(!target) return;
                                if(target.matches('#signupBtn')){ e.preventDefault(); showModal('signup'); return; }
                                if(target.matches('#createAccountBtn')){ e.preventDefault(); showModal('signup'); return; }
                                if(target.matches('#loginAccountBtn')){ e.preventDefault(); showModal('login'); return; }
                                if(target.matches('#myAccountBtn')){ e.preventDefault(); showUserAccountModal(); return; }
                                if(target.matches('#closeModal') || target.matches('#cancelBtn')){ e.preventDefault(); hideModal(); hidePopover(); return; }
                                if(target.matches('#closePopover') || target.matches('#closePopoverBtn')){ e.preventDefault(); hidePopover(); return; }
                                if(target.matches('#forgotPwdBtn')){ 
                                    e.preventDefault(); 
                                    const email = prompt('Enter your email address to reset password:');
                                    if(email && email.trim()){
                                        auth.sendPasswordResetEmail(email.trim())
                                        .then(() => alert('Password reset email sent! Check your inbox.'))
                                        .catch(err => alert('Error sending reset email: ' + err.message));
                                    }
                                    return; 
                                }
                        }, true);

                        // Attach a direct click handler to the login button to open the popover (keep dropdown open)
                        const directLoginBtn = document.getElementById('loginBtn');
                        if(directLoginBtn) {
                            // attach in capture phase to ensure this runs before some global handlers
                directLoginBtn.addEventListener('click', function(e){
                    console.log('direct loginBtn clicked (capture)');
                    // prevent other handlers from interfering
                    e.preventDefault();
                    e.stopPropagation();
                    // ensure dropdown remains open: if the menu is closed, open it
                    try {
                        const lm = document.getElementById('loginMenu');
                        if (lm && !lm.classList.contains('open')) lm.classList.add('open');
                    } catch(_){}
                    // open centered modal for login (match signup behavior)
                    showModal('login');
                }, true);
                            // also open on mousedown to run before any click-induced menu toggles
                            directLoginBtn.addEventListener('mousedown', function(e){
                                console.log('direct loginBtn mousedown');
                                try {
                                    const lm = document.getElementById('loginMenu');
                                    if (lm && !lm.classList.contains('open')) lm.classList.add('open');
                                } catch(_){ }
                                // do not prevent default here so menu item behaves normally
                                showModal('login');
                            }, true);
                            // also add a fallback non-capture listener
                            directLoginBtn.addEventListener('click', function(e){
                                console.log('direct loginBtn clicked (bubble)');
                            });
                        }
                        // Logout handler (Firebase only)
                        document.addEventListener('click', function(e){
                            if(e.target && e.target.matches('#logoutBtn')){
                                auth.signOut().then(()=>{
                                    alert('Signed out');
                                    hideContent();
                                    updateLoginDropdown(false);
                                    showModal('login');
                                }).catch(err=> alert('Sign out error: '+err.message));
                            }
                        }, true);
                                // Also make the profile icon open the popover directly (prevent dropdown toggle)
                                                // Keep the profile icon behavior unchanged: it toggles the dropdown via existing app.js logic

                // click outside popover should close it
                document.addEventListener('click', function(e){
                        if(!loginPopover) return;
                        if(!loginPopover.classList.contains('hidden')){
                                const isInside = loginPopover.contains(e.target) || (loginMenuToggle && loginMenuToggle.contains(e.target));
                                if(!isInside) hidePopover();
                        }
                }, false);

                // ESC key
                document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ hideModal(); hidePopover(); } });

                // Backdrop clicks close modal
                if(modalBackdrop){
                        modalBackdrop.addEventListener('click', function(e){ if(e.target === modalBackdrop) hideModal(); });
                }

        // Handle form submissions for popover, modal signup and modal login
        // If Firebase is initialized we'll use Auth + Firestore; otherwise fall back to localStorage demo helpers.
        document.addEventListener('submit', function(e){
            const form = e.target;
            if(!form) return;
            // Helper to ensure firebase is available
            const hasFirebase = !!(auth && db);

            // Login from popover
            if(form.id === 'loginPopoverForm'){
                e.preventDefault();
                const fullName = (document.getElementById('loginFullName')||{}).value || '';
                const emailOrMobile = (document.getElementById('loginEmail')||{}).value || '';
                const pwd = (document.getElementById('loginPassword')||{}).value || '';
                if(!fullName || !emailOrMobile || !pwd){ alert('Please fill all fields'); return; }
                
                // Check if input is email or mobile number
                const isEmail = emailOrMobile.includes('@');
                if(isEmail){
                    auth.signInWithEmailAndPassword(emailOrMobile, pwd)
                    .then(()=>{ 
                        alert('Login successful'); 
                        hidePopover(); 
                        // Update dropdown will be handled by auth state change
                    })
                    .catch(err=> alert('Login failed: ' + err.message));
                } else {
                    // For mobile number, we need to find user by mobile in Firestore first
                    db.collection('users').where('mobile', '==', emailOrMobile).get()
                    .then(snapshot => {
                        if(snapshot.empty) {
                            alert('No account found with that mobile number');
                            return;
                        }
                        const userDoc = snapshot.docs[0];
                        const email = userDoc.data().email;
                        return auth.signInWithEmailAndPassword(email, pwd);
                    })
                    .then(()=>{ 
                        alert('Login successful'); 
                        hidePopover(); 
                        // Update dropdown will be handled by auth state change
                    })
                    .catch(err=> alert('Login failed: ' + err.message));
                }
                return;
            }

            // Signup modal
            if(form.id === 'signupForm'){
                e.preventDefault();
                const fullName = (document.getElementById('signupFullName')||{}).value || '';
                const email = (document.getElementById('signupEmail')||{}).value || '';
                const mobile = (document.getElementById('signupMobile')||{}).value || '';
                const pwd = (document.getElementById('signupPassword')||{}).value || '';
                const conf = (document.getElementById('signupConfirm')||{}).value || '';
                if(!fullName || !email || !mobile || !pwd || !conf){ alert('Please fill all fields'); return; }
                if(pwd !== conf){ alert('Passwords do not match'); return; }
                
                auth.createUserWithEmailAndPassword(email, pwd)
                .then(cred => {
                    const uid = cred.user.uid;
                    return saveProfile(uid, { fullName: fullName, email: email, mobile: mobile, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                })
                .then(()=>{ 
                    alert('Account created successfully. You are signed in.'); 
                    hideModal(); 
                    // Update dropdown will be handled by auth state change
                })
                .catch(err=> alert('Signup failed: ' + err.message));
                return;
            }

            // Login modal (centered)
            if(form.id === 'loginForm'){
                e.preventDefault();
                const fullName = (document.getElementById('loginFullName')||{}).value || '';
                const emailOrMobile = (document.getElementById('loginEmail')||{}).value || '';
                const pwd = (document.getElementById('loginPassword')||{}).value || '';
                if(!fullName || !emailOrMobile || !pwd){ alert('Please fill all fields'); return; }
                
                // Check if input is email or mobile number
                const isEmail = emailOrMobile.includes('@');
                if(isEmail){
                    auth.signInWithEmailAndPassword(emailOrMobile, pwd)
                    .then(()=>{ 
                        alert('Login successful'); 
                        hideModal(); 
                        // Update dropdown will be handled by auth state change
                    })
                    .catch(err=> alert('Login failed: ' + err.message));
                } else {
                    // For mobile number, we need to find user by mobile in Firestore first
                    db.collection('users').where('mobile', '==', emailOrMobile).get()
                    .then(snapshot => {
                        if(snapshot.empty) {
                            alert('No account found with that mobile number');
                            return;
                        }
                        const userDoc = snapshot.docs[0];
                        const email = userDoc.data().email;
                        return auth.signInWithEmailAndPassword(email, pwd);
                    })
                    .then(()=>{ 
                        alert('Login successful'); 
                        hideModal(); 
                        // Update dropdown will be handled by auth state change
                    })
                    .catch(err=> alert('Login failed: ' + err.message));
                }
                return;
            }
            // User account update form
            if(form.id === 'userAccountForm'){
                e.preventDefault();
                const fullName = (document.getElementById('accountFullName')||{}).value || '';
                const email = (document.getElementById('accountEmail')||{}).value || '';
                const mobile = (document.getElementById('accountMobile')||{}).value || '';
                const newPassword = (document.getElementById('accountPassword')||{}).value || '';
                const confirmPassword = (document.getElementById('accountConfirmPassword')||{}).value || '';
                
                if(!fullName || !email || !mobile){ alert('Please fill all required fields'); return; }
                if(newPassword && newPassword !== confirmPassword){ alert('New passwords do not match'); return; }
                
                const user = auth.currentUser;
                if(!user) { alert('No user logged in'); return; }
                
                // Update email if changed
                if(user.email !== email){
                    user.updateEmail(email)
                    .catch(err => alert('Error updating email: ' + err.message));
                }
                
                // Update password if provided
                if(newPassword){
                    user.updatePassword(newPassword)
                    .catch(err => alert('Error updating password: ' + err.message));
                }
                
                // Update profile in Firestore
                saveProfile(user.uid, { fullName: fullName, email: email, mobile: mobile })
                .then(() => {
                    alert('Account updated successfully');
                    hideModal();
                    // Refresh the dropdown
                    updateLoginDropdown(true, { fullName: fullName, email: email, mobile: mobile });
                })
                .catch(err => alert('Error updating profile: ' + err.message));
                return;
            }
        }, true);
        })();
        </script>

    <!-- Numbered boxes at bottom -->
    <div class="bottom-boxes">
        <div class="number-box">1</div>
        <div class="number-box">2</div>
        <div class="number-box">3</div>
        <div class="number-box">4</div>
        <div class="number-box">5</div>
        <div class="number-box">6</div>
        <div class="number-box">7</div>
        <div class="number-box">8</div>
        <div class="number-box">9</div>
        <div class="number-box">10</div>
        <div class="number-box">11</div>
        <div class="number-box">12</div>
        <div class="number-box">13</div>
        <div class="number-box">14</div>
        <div class="number-box">15</div>
        <div class="number-box">16</div>
        <div class="number-box">17</div>
        <div class="number-box">18</div>
        <div class="number-box">19</div>
        <div class="number-box">20</div>
        <div class="number-box">21</div>
        <div class="number-box">22</div>
        <div class="number-box">23</div>
        <div class="number-box">24</div>
        <div class="number-box">25</div>
        <div class="number-box">26</div>
        <div class="number-box">27</div>
        <div class="number-box">28</div>
        <div class="number-box">29</div>
    </div>

    <!-- Musical symbols background -->
    <div class="music-bg">
        <span class="music-symbol" style="top:7%;left:12%;">üéµ</span>
        <span class="music-symbol" style="top:18%;left:77%;">üé∂</span>
        <span class="music-symbol" style="top:62%;left:8%;">üé∑</span>
        <span class="music-symbol" style="top:73%;left:68%;">üé∏</span>
        <span class="music-symbol" style="top:41%;left:53%;">ü™ó</span>
        <span class="music-symbol" style="top:81%;left:27%;">üéπ</span>
        <span class="music-symbol" style="top:33%;left:63%;">üéª</span>
        <span class="music-symbol" style="top:52%;left:88%;">üé∫</span>
        <span class="music-symbol" style="top:15%;left:35%;">üé∫</span>
        <span class="music-symbol" style="top:85%;left:55%;">ü•Å</span>
        <span class="music-symbol" style="top:25%;left:15%;">ü™à</span>
        <span class="music-symbol" style="top:60%;left:80%;">üéº</span>
        <span class="music-symbol" style="top:10%;left:90%;">üé∂</span>
        <span class="music-symbol" style="top:90%;left:10%;">üé∑</span>
        <span class="music-symbol" style="top:50%;left:40%;">üé∏</span>
        <span class="music-symbol" style="top:70%;left:20%;">ü•Å</span>
        <span class="music-symbol" style="top:30%;left:85%;">üé∫</span>
        <span class="music-symbol" style="top:80%;left:70%;">üéª</span>
        <span class="music-symbol" style="top:20%;left:50%;">üé§</span>
        <span class="music-symbol" style="top:60%;left:60%;">ü™ó</span>
        <!-- extra desktop-only symbols to reduce blank space -->
        <span class="music-symbol extra" style="top:12%;left:48%">üéµ</span>
        <span class="music-symbol extra" style="top:22%;left:70%">üé∂</span>
        <span class="music-symbol extra" style="top:35%;left:30%">üé∑</span>
        <span class="music-symbol extra" style="top:45%;left:78%">üé∏</span>
        <span class="music-symbol extra" style="top:55%;left:20%">üé∫</span>
        <span class="music-symbol extra" style="top:65%;left:50%">üéª</span>
        <span class="music-symbol extra" style="top:75%;left:85%">ü•Å</span>
        <span class="music-symbol extra" style="top:28%;left:58%">üéπ</span>
        <span class="music-symbol extra" style="top:8%;left:82%">üé§</span>
        <span class="music-symbol extra" style="top:82%;left:38%">ü™à</span>
        <span class="music-symbol extra" style="top:50%;left:12%">üéº</span>
        <!-- extra symbols concentrated toward top-left of main area -->
        <span class="music-symbol extra-top-left" style="top:6%;left:28%">üéµ</span>
        <span class="music-symbol extra-top-left" style="top:10%;left:34%">üé∂</span>
        <span class="music-symbol extra-top-left" style="top:14%;left:22%">üé∑</span>
        <span class="music-symbol extra-top-left" style="top:18%;left:40%">üé∏</span>
        <span class="music-symbol extra-top-left" style="top:4%;left:48%">ü•Å</span>
    </div>
        <script>
        // Randomize desktop symbol motion using CSS variables
                (function(){
                    if(window.matchMedia && !window.matchMedia('(min-width: 901px)').matches) return; // only on desktop
                    const bg = document.querySelector('.music-bg');
                    if(!bg) return;
                    // create extra symbols dynamically to increase density (desktop only)
                    const existing = bg.querySelectorAll('.music-symbol').length;
                    const target = Math.max(40, Math.ceil(window.innerWidth / 30)); // target count based on width
                    const extraToAdd = Math.max(0, target - existing);
                    for(let i=0;i<extraToAdd;i++){
                        const span = document.createElement('span');
                        span.className = 'music-symbol extra';
                        // position randomly but keep some margin
                        const top = (5 + Math.random()*90).toFixed(1) + '%';
                        const left = (3 + Math.random()*94).toFixed(1) + '%';
                        const icons = ['üéµ','üé∂','üé∑','üé∏','ü•Å','üé∫','üéª','üéπ','üé§','ü™à','ü™ó','üéº'];
                        const icon = icons[Math.floor(Math.random()*icons.length)];
                        span.style.top = top;
                        span.style.left = left;
                        span.textContent = icon;
                        bg.appendChild(span);
                    }

                    const syms = document.querySelectorAll('.music-symbol');
                    syms.forEach(function(el, idx){
                        // assign multiple random waypoints (x0..x4, y0..y4, r0..r4)
                        for(let i=0;i<=4;i++){
                            const x = (Math.random()*420 - 210).toFixed(1) + 'px';
                            const y = (Math.random()*420 - 210).toFixed(1) + 'px';
                            const r = (Math.random()*140 - 70).toFixed(1) + 'deg';
                            el.style.setProperty('--x'+i, x);
                            el.style.setProperty('--y'+i, y);
                            el.style.setProperty('--r'+i, r);
                        }
                        // random overall duration and staggered delay
                        const dur = (10 + Math.random()*12).toFixed(2) + 's';
                        const delay = (Math.random()*6).toFixed(2) + 's';
                        el.style.animationDuration = dur;
                        el.style.animationDelay = delay;
                    });
                })();
        </script>
</body>
</html>


